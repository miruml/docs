---
title: 'Custom Validation'
description: 'Implement custom validation logic for your config instances.'
---

import CreateAPIKey from '/snippets/api-keys/create.mdx';

## Overview

Miru natively supports the use of JSON Schema to specify [config schemas](/docs/home/basics/vocabulary#config-schema) used to validate [config instances](/docs/home/basics/vocabulary#config-instance) before deployment. However, some config instances may require more complex, application-specific validation logic to ensure valid configurations are deployed.

Miru allows you to implement custom validation logic via [webhooks](/docs/api-reference/webhooks/events/config-instances/validate) and [Server-Side APIs](/docs/api-reference/server-side), ensuring configurations are valid before deployment to your devices.

Upon any new config instance deployments made in the UI (or otherwise), Miru will trigger the [config instance validation webhook](/docs/api-reference/webhooks/events/config-instances/validate) to your endpoint(s). 

The config instance must then be approved or rejected using the [approve](/docs/api-reference/server-side/endpoints/config-instances/approve) or [reject](/docs/api-reference/server-side/endpoints/config-instances/reject) APIs. Once config instance has been approved, deploy the config instance to its target device using the [deploy](/docs/api-reference/server-side/endpoints/config-instances/deploy) API.

This guide walks through the steps of setting up a custom validation server. If you're new to webhooks or looking for a quick way to test your custom validation server locally, be sure to check out the [Local Testing with `ngrok`](#local-testing-with-ngrok) section.


## Enable
Custom validation is enabled on a per-config type basis.

To enable custom validation for a config type, navigate to the [Config Types](https://configs.miruml.com/configs) page. Click the ellipses on the far right of the config type you would like to enable and select **Edit** from the dropdown.

<Frame>
  ![](/images/custom-validation/enable-dialog.png)
</Frame>

Toggle the **Custom Validation** setting.

<Warning>
    Enabling custom validation *requires* you to received the validation webhook and approve /  deploy config instances via APIs for that config type. If these APIs are not implemented, config instances will remain in the `validating` state indefinitely.
</Warning>

## Create an Endpoint

Next, you'll need to create an endpoint to receive webhook events.

Navigate to the [webhooks](https://configs.miruml.com/webhooks) page in Miru. 

<Frame>
  ![](/images/custom-validation/wbhk-header.png)
</Frame>

Click **Add Endpoint** in the top right of the page.

<Frame>
  ![](/images/custom-validation/create-wbhk-ep.png)
</Frame>

Enter the full server URL to send the webhook event to. We recommend using a route similar to `/webhooks/miru` to receive the webhook event, but you may use any route you prefer.

<Warning>
    Your URL must use HTTPS (HTTP is not supported).
</Warning>

Your URL should be of the form `https://<your-domain>/<route>`. For instance, if your domain is `my-domain.com` and you want to use the route `/webhooks/miru`, your URL would be `https://my-domain.com/webhooks/miru`.

Finally, enter a description for the endpoint, select the `config_instance.target_status.validated` event, and click **Create**.

## Secrets

### Webhook Secret

The first secret you'll need is the webhook secret for verifying the webhook event.

To fetch the webhook secret for you endpoint, click into the endpoint. Then, click the **eye** icon on the far right of the page to reveal the webhook secret.

<Frame>
  ![](/images/custom-validation/wbhk-ep-view.png)
</Frame>

### API Key

The second secret you'll need is an API key for authenticating requests to the Miru API.

To create an API key:

<CreateAPIKey />

## Receive the Webhook

On the far right of the page, you'll see the webhook secret. Copy this value and store it in a secure location for use in your validation server. 

For simplicity the flask server uses the `SECRET` as a globally defined variable but you should not do this in practice. Webhook secrets should be stored in a secrets manager or other secure location, not inside your codebase.

## Receiving the Webhook

To receive the validation webhook, you must create a 


## Approve the Config Instance

After receiving the `config_instance.target_status.validated` webhook, you'll need to approve the config instance using the [approve](/docs/api-reference/server-side/config-instances/approve) API.

The approve API stores a success `message` field and moves the config instance's `activity_status` to be `validated`.

You can approve the config instance by making the appropriate POST request in the API [`Playground`](/docs/api-reference/server-side/config-instances/approve?playground=open). We recommend making a dedicated **api-playground-key** for this purpose which you delete after you're done testing.

Alternatively, if the config instance is invalid you can use the [reject](/docs/api-reference/server-side/config-instances/reject) API to reject the config instance. This will move the config instance's `error_status` to be `failed`, preventing any deployments to it's target device.

The reject API stores a failure `message` field as well as a list of parameter `errors` that caused the validation to fail. Be sure to give a descriptive message and errors, as these will be displayed in the UI for rejected config instances.


## Deploy the Config Instance

Finally, with the config instance approved, you can deploy the config instance to it's target device using the [deploy](/docs/api-reference/server-side/config-instances/deploy) API.

The config instance must have been approved by your validation server before it can be deployed to it's target device. If the config instance has not been approved, the deploy API will return an error stating that the config instance is not in a valid state for deployment.

## Local Testing with `ngrok`


### Flask Server 
Webhooks rely on a web server provisioned by you to receive and process webhook events.

We'll walk through the setup of a simple server using Python and Flask.

Begin by cloning the [getting-started](https://github.com/miruml/getting-started) repository.

```
git clone https://github.com/miruml/getting-started.git
```

Navigate to the Python `server-sdk` directory inside the repository.

```
cd getting-started/python/server-sdk
```

Inside the `flask` directory you'll find a simple flask application (`app.py`) which demonstrates webhook verification using the Miru server-side SDK.

To run the server, create a virtual environment and install the dependencies.

```
python3 -m venv .venv
```
```
source .venv/bin/activate
```
```
python3 -m pip install -r requirements.txt
```

Then run the server.

```
cd flask
```
```
python3 app.py
```

Verify the server is running by going to http://localhost:5000 in your browser. You should see 

    `{"message":"ok"}`
 

### `ngrok` Setup

Miru webhooks don't support sending requests to your local machine directly. All requests must be sent to valid domains over HTTPS. 

To test Miru webhooks locally, we'll need to setup tunneling with `ngrok`. This will provision a temporary domain that forwards requests to your local machine, a useful method for locally testing webhooks.

1. Navigate to [ngrok](https://ngrok.com/) and create an account

1. Install `ngrok` to your machine according to their [installation instructions](https://dashboard.ngrok.com/get-started/setup/linux) and add your authoken to the `ngrok` configuration file.

1. Forward an ephemeral domain to your Flask application over on port 5000

    ```
    ngrok http http://localhost:5000
    ```

    You should see a domain similar to `https://c1971566f336.ngrok-free.app` being forward to your Flask server.

As before, you can verify the server is running by going to `https://<YOUR_NGROK_DOMAIN>.ngrok-free.app` (you'll need to replace `<YOUR_NGROK_DOMAIN>`  with your own ngrok host domain like `c1971566f336`) in your browser. You should see `{"message":"ok"}`.



### Send an Example Webhook
To send an example webhook to your validation server, select the **Testing** tab under your webhook endpoint. In the middle of the page, you'll see a **Send Example** button. Select the `config_instance.target_status.validated` event and click **Send Example**.

If your secret is key is invalid or not specified, you'll see an error message in Miru for that request similar to:

```
{"message":"No matching signature found"}
```

If your server is properly configured, you'll see a response in miru for that request similar to:

```
{"message":"webhook successfully received"}
```

### Trigger the Webhook
To trigger a real webhook, you'll need to deploy a config instance to a device. To do this, navigate to the [Devices](https://configs.miruml.com/devices) page in Miru.

Either provision a new device with config instances or select an existing device to deploy a config instance to.

<Warning>
    Remember to deploy a config instances with a config type that has custom validation enabled. If custom validation is disabled, the `config_instance.target_status.validated` webhook will not be triggered.
</Warning>

Upon deployment of a config instance, you'll notice the config instance is in the `validating` state, indicating that it is awaiting approval from your validation server before deployment to it's target device.