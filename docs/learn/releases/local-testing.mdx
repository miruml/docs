{/* ---
title: "Local Testing"
---

### Run Locally

This section is optional. However, you may find it useful to clone and run the server locally to test that everything is working before deploying to a remote server.

Begin by cloning the [custom-validation](https://github.com/miruml/custom-validation) repository.

```
git clone https://github.com/miruml/custom-validation.git
```

Navigate inside the repository.

```
cd custom-validation
```

Inside the `flask` directory, you'll find a simple Flask application (`app.py`). To run the application, first create a virtual environment and install the dependencies.

```
python3 -m venv .venv
```

```
source .venv/bin/activate
```

```
python3 -m pip install -r requirements.txt
```

Then run the server.

```
cd flask
```

```
python3 app.py
```

Verify the server is running by going to http://localhost:5000 in your browser. You should see  `{"message":"ok"}` in your browser.

## Receive the Webhook

On the far right of the page, you'll see the webhook secret. Copy this value and store it in a secure location for use in your validation server.

For simplicity, the Flask server uses the `SECRET` as a globally defined variable, but you should not do this in practice. Webhook secrets should be stored in a secrets manager or other secure location, not inside your codebase.

## Receiving the Webhook

To receive the validation webhook, you must create a

## Approve the Config Instance

After receiving the `config_instance.target_status.validated` webhook, you'll need to approve the config instance using the [approve](/docs/references/server-side-api/config-instances/approve) API.

The approve API stores a success `message` field and moves the config instance's `activity_status` to be `validated`.

You can approve the config instance by making the appropriate POST request in the API [`Playground`](/docs/references/server-side-api/config-instances/approve?playground=open). We recommend making a dedicated **api-playground-key** for this purpose which you delete after you're done testing.

Alternatively, if the config instance is invalid you can use the [reject](/docs/references/server-side-api/config-instances/reject) API to reject the config instance. This will move the config instance's `error_status` to be `failed`, preventing any deployments to it's target device.

The reject API stores a failure `message` field as well as a list of parameter `errors` that caused the validation to fail. Be sure to give a descriptive message and errors, as these will be displayed in the UI for rejected config instances.

## Deploy the Config Instance

Finally, with the config instance approved, you can deploy the config instance to it's target device using the [deploy](/docs/references/server-side-api/config-instances/deploy) API.

The config instance must have been approved by your validation server before it can be deployed to it's target device. If the config instance has not been approved, the deploy API will return an error stating that the config instance is not in a valid state for deployment.

## Local Testing with `ngrok`

### `ngrok` Setup

Miru webhooks don't support sending requests to your local machine directly. All requests must be sent to valid domains over HTTPS.

To test Miru webhooks locally, we'll need to setup tunneling with `ngrok`. This will provision a temporary domain that forwards requests to your local machine, a useful method for locally testing webhooks.

1. Navigate to [ngrok](https://ngrok.com/) and create an account
1. Install `ngrok` to your machine according to their [installation instructions](https://dashboard.ngrok.com/get-started/setup/linux) and add your authoken to the `ngrok` configuration file.
1. Forward an ephemeral domain to your Flask application over on port 5000

   ```
   ngrok http http://localhost:5000
   ```

   You should see a domain similar to `https://c1971566f336.ngrok-free.app` being forward to your Flask server.

As before, you can verify the server is running by going to `https://<YOUR_NGROK_DOMAIN>.ngrok-free.app` (you'll need to replace `<YOUR_NGROK_DOMAIN>`  with your own ngrok host domain like `c1971566f336`) in your browser. You should see `{"message":"ok"}`.

### Send an Example Webhook

To send an example webhook to your validation server, select the **Testing** tab under your webhook endpoint. In the middle of the page, you'll see a **Send Example** button. Select the `config_instance.target_status.validated` event and click **Send Example**.

If your secret is key is invalid or not specified, you'll see an error message in Miru for that request similar to:

```
{"message":"No matching signature found"}
```

If your server is properly configured, you'll see a response in miru for that request similar to:

```
{"message":"webhook successfully received"}
```

### Trigger the Webhook

To trigger a real webhook, you'll need to deploy a config instance to a device. To do this, navigate to the [Devices](https://app.miruml.com/devices) page in Miru.

Either provision a new device with config instances or select an existing device to deploy a config instance to.

<Warning>
  Remember to deploy a config instances with a config type that has custom validation enabled. If custom validation is disabled, the `config_instance.target_status.validated` webhook will not be triggered.
</Warning>

Upon deployment of a config instance, you'll notice the config instance is in the `validating` state, indicating that it is awaiting approval from your validation server before deployment to it's target device. */}